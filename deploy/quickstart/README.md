# Harbor Satellite SPIFFE Quickstart

This directory contains deployment scripts for testing Harbor Satellite with SPIFFE/SPIRE authentication.

## Overview

Harbor Satellite supports SPIFFE (Secure Production Identity Framework for Everyone) for zero-trust authentication between Satellite instances and Ground Control. This enables:

- Cryptographic identity verification using X.509 SVIDs
- Mutual TLS (mTLS) for secure communication
- Automatic certificate rotation
- Platform-agnostic workload identity

## Authentication Methods

### 1. Join Token (Recommended for Testing)

The simplest method for development and testing. SPIRE agents authenticate using a one-time token generated by the SPIRE server.

```bash
cd join-token
./setup.sh
./test.sh
./cleanup.sh
```

**Use cases:**
- Development environments
- Quick testing
- CI/CD pipelines

### 2. X.509 Certificate (Recommended for Production)

Agents authenticate using pre-provisioned X.509 certificates. Suitable for environments where certificates can be securely distributed before deployment.

```bash
cd x509-cert
./setup.sh
./test.sh
./cleanup.sh
```

**Use cases:**
- Production environments
- Enterprise deployments
- Environments with existing PKI

### 3. TPM-based (Hardware Security)

Agents authenticate using TPM (Trusted Platform Module) hardware attestation. This provides the highest security by binding identity to physical hardware.

**Requirements:**
- Physical or virtual TPM 2.0
- Linux with TPM support enabled

**Note:** TPM attestation requires specific hardware support and is not included in these quickstart scripts. See the SPIRE documentation for TPM configuration.

## Architecture

```
+------------------+     +------------------+     +------------------+
|   SPIRE Server   |<--->|  SPIRE Agent GC  |<--->| Ground Control   |
+------------------+     +------------------+     +------------------+
        ^                                                  ^
        |                                                  |
        v                                                  v
+------------------+     +------------------+     +------------------+
|  SPIRE Agent Sat |<--->|    Satellite     |---->| mTLS Connection  |
+------------------+     +------------------+     +------------------+
```

## Components

| Component | Port | Description |
|-----------|------|-------------|
| SPIRE Server | 8081 | Central identity authority |
| Ground Control | 8080 | Fleet management API |
| Mock Harbor | 5000 | Simulated container registry |
| PostgreSQL | 5432 | Ground Control database |

## Endpoints

After setup, these endpoints are available:

- `http://localhost:8080/ping` - Ground Control health check
- `http://localhost:8080/spire/status` - SPIFFE status
- `http://localhost:8080/satellites` - Satellite management
- `http://localhost:5000/v2/` - Mock Harbor registry

## Troubleshooting

### SPIRE Server not starting
```bash
docker logs spire-server
```

### Agent not attesting
```bash
# Check agent logs
docker logs spire-agent-gc
docker logs spire-agent-satellite

# List agents from server
docker exec spire-server /opt/spire/bin/spire-server agent list \
    -socketPath /tmp/spire-server/private/api.sock
```

### Workload not receiving SVID
```bash
# List entries
docker exec spire-server /opt/spire/bin/spire-server entry show \
    -socketPath /tmp/spire-server/private/api.sock

# Check agent socket
docker exec ground-control ls -la /run/spire/sockets/
```

### Ground Control SPIFFE issues
```bash
docker logs ground-control
curl http://localhost:8080/spire/status
```

## Configuration

### Satellite SPIFFE Configuration

In `config.json`:
```json
{
  "app_config": {
    "spiffe": {
      "enabled": true,
      "endpoint_socket": "unix:///run/spire/sockets/agent.sock",
      "expected_server_id": "spiffe://harbor-satellite.local/ground-control"
    }
  }
}
```

Or via environment variables:
```bash
SPIFFE_ENABLED=true
SPIFFE_ENDPOINT_SOCKET=unix:///run/spire/sockets/agent.sock
SPIFFE_EXPECTED_SERVER_ID=spiffe://harbor-satellite.local/ground-control
```

Or via CLI flags:
```bash
./satellite --spiffe-enabled \
    --spiffe-endpoint-socket unix:///run/spire/sockets/agent.sock \
    --spiffe-expected-server-id spiffe://harbor-satellite.local/ground-control
```

### Ground Control SPIFFE Configuration

Environment variables:
```bash
SPIFFE_ENABLED=true
SPIFFE_ENDPOINT_SOCKET=unix:///run/spire/sockets/agent.sock
SPIFFE_TRUST_DOMAIN=harbor-satellite.local
```

## Security Considerations

1. **Trust Domain**: Use a unique trust domain for your organization (e.g., `yourorg.example.com`)
2. **CA Certificates**: In production, use certificates from your organization's PKI
3. **SVID TTL**: Configure appropriate TTL for your security requirements
4. **Network Policies**: Restrict access to SPIRE components

## Next Steps

1. Deploy in Kubernetes using the provided Helm charts
2. Configure production-grade SPIRE with external CA
3. Set up monitoring and alerting for SPIFFE components
