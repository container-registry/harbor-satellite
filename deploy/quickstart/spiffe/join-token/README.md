# Join Token Attestation

One-time tokens generated by the SPIRE server. Simplest method for getting started.

Tokens are single-use: once a SPIRE agent uses a token to attest, it cannot be reused.

## Prerequisites

- Docker and docker compose installed
- Harbor running (or use SKIP_HARBOR_HEALTH_CHECK=true for testing)
- Ground Control and Satellite built (or use docker images)

## Step 1: Start Ground Control with External SPIRE

### 1.1 Generate bootstrap CA certificate

```bash
cd external/gc
./generate-certs.sh
```

Or manually:
```bash
mkdir -p certs
openssl genrsa -out certs/ca.key 4096
openssl req -new -x509 -days 365 -key certs/ca.key -out certs/ca.crt \
    -subj "/C=US/ST=State/L=City/O=Harbor Satellite/CN=SPIRE CA"
```

### 1.2 Start SPIRE server and PostgreSQL

```bash
docker compose up -d postgres spire-server
```

### 1.3 Wait for SPIRE server to be healthy

```bash
docker exec spire-server /opt/spire/bin/spire-server healthcheck \
    -socketPath /tmp/spire-server/private/api.sock
```

### 1.4 Generate join token for GC agent

```bash
docker exec spire-server /opt/spire/bin/spire-server token generate \
    -spiffeID spiffe://harbor-satellite.local/agent/ground-control \
    -socketPath /tmp/spire-server/private/api.sock
```

Save the token value from the output.

### 1.5 Create agent config with token

Create `spire/agent-gc-runtime.conf` with the token from step 1.4:

```bash
cat > spire/agent-gc-runtime.conf << EOF
agent {
    data_dir = "/opt/spire/data/agent"
    log_level = "INFO"
    server_address = "spire-server"
    server_port = "8081"
    socket_path = "/run/spire/sockets/agent.sock"
    trust_bundle_path = "/opt/spire/conf/agent/bootstrap.crt"
    trust_domain = "harbor-satellite.local"
    join_token = "YOUR_TOKEN_HERE"
}

plugins {
    NodeAttestor "join_token" {
        plugin_data {}
    }
    KeyManager "disk" {
        plugin_data {
            directory = "/opt/spire/data/agent"
        }
    }
    WorkloadAttestor "unix" {
        plugin_data {}
    }
    WorkloadAttestor "docker" {
        plugin_data {
            docker_socket_path = "unix:///var/run/docker.sock"
        }
    }
}

health_checks {
    listener_enabled = true
    bind_address = "0.0.0.0"
    bind_port = "8080"
    live_path = "/live"
    ready_path = "/ready"
}
EOF
```

### 1.6 Start SPIRE agent for GC

```bash
docker compose up -d spire-agent-gc
```

### 1.7 Register GC workload

```bash
docker exec spire-server /opt/spire/bin/spire-server entry create \
    -parentID spiffe://harbor-satellite.local/agent/ground-control \
    -spiffeID spiffe://harbor-satellite.local/ground-control \
    -selector docker:label:com.docker.compose.service:ground-control \
    -socketPath /tmp/spire-server/private/api.sock
```

### 1.8 Start Ground Control

```bash
docker compose up -d ground-control
```

### 1.9 Verify GC is running

GC serves HTTPS when SPIFFE is enabled. Use `-k` to skip certificate verification.

```bash
curl -sk https://localhost:9080/ping
curl -sk https://localhost:9080/api/spire/status  # requires system_admin role
```

## Step 2: Create Config and Group

### 2.1 Login to Ground Control

```bash
LOGIN_RESP=$(curl -sk -X POST https://localhost:9080/login \
    -H "Content-Type: application/json" \
    -d '{"username":"admin","password":"Harbor12345"}')
AUTH_TOKEN=$(echo "$LOGIN_RESP" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
```

### 2.2 Create a satellite config

This config is fetched by satellites and controls local registry setup, replication intervals, and heartbeat reporting.

```bash
curl -sk -X POST https://localhost:9080/api/configs \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer ${AUTH_TOKEN}" \
    -d '{
      "config_name": "default",
      "config": {
        "app_config": {
          "log_level": "info",
          "state_replication_interval": "@every 00h00m30s",
          "register_satellite_interval": "@every 00h00m05s",
          "heartbeat_interval": "@every 00h00m30s",
          "metrics": {
            "collect_cpu": true,
            "collect_memory": true,
            "collect_storage": true
          },
          "local_registry": {
            "url": "http://127.0.0.1:8585"
          }
        },
        "zot_config": {
          "distSpecVersion": "1.1.0",
          "storage": { "rootDirectory": "./zot" },
          "http": { "address": "0.0.0.0", "port": "8585" },
          "log": { "level": "info" }
        }
      }
    }'
```

### 2.3 Create a group with images

Sync a group containing the images you want the satellite to replicate. Replace the artifact details with images from your Harbor instance.

```bash
curl -sk -X POST https://localhost:9080/api/groups/sync \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer ${AUTH_TOKEN}" \
    -d '{
      "group": "edge-images",
      "registry": "http://localhost:8080",
      "artifacts": [
        {
          "repository": "library/nginx",
          "tag": ["latest"],
          "type": "image",
          "digest": "sha256:YOUR_DIGEST_HERE"
        }
      ]
    }'
```

## Step 3: Start Satellite with External SPIRE

### 3.1 Request join token from Ground Control

```bash
curl -sk -X POST https://localhost:9080/api/join-tokens \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer ${AUTH_TOKEN}" \
    -d '{"satellite_name":"edge-01","region":"us-west"}'
```

The response includes the join token and SPIRE server connection details:
```json
{
  "join_token": "...",
  "expires_at": "...",
  "spiffe_id": "spiffe://harbor-satellite.local/satellite/region/us-west/edge-01",
  "region": "us-west",
  "satellite": "edge-01",
  "spire_server_address": "spire-server",
  "spire_server_port": 8081,
  "trust_domain": "harbor-satellite.local"
}
```

### 3.2 Create satellite agent config

```bash
cd ../sat
```

Create `spire/agent-satellite-runtime.conf` with the join token from step 3.1:

```bash
cat > spire/agent-satellite-runtime.conf << EOF
agent {
    data_dir = "/opt/spire/data/agent"
    log_level = "INFO"
    server_address = "spire-server"
    server_port = "8081"
    socket_path = "/run/spire/sockets/agent.sock"
    trust_bundle_path = "/opt/spire/conf/agent/bootstrap.crt"
    trust_domain = "harbor-satellite.local"
    join_token = "YOUR_TOKEN_HERE"
}

plugins {
    NodeAttestor "join_token" {
        plugin_data {}
    }
    KeyManager "disk" {
        plugin_data {
            directory = "/opt/spire/data/agent"
        }
    }
    WorkloadAttestor "unix" {
        plugin_data {}
    }
    WorkloadAttestor "docker" {
        plugin_data {
            docker_socket_path = "unix:///var/run/docker.sock"
        }
    }
}

health_checks {
    listener_enabled = true
    bind_address = "0.0.0.0"
    bind_port = "8080"
    live_path = "/live"
    ready_path = "/ready"
}
EOF
```

### 3.3 Register satellite workload

Register the satellite workload entry so it can receive an SVID after the agent attests:

```bash
docker exec spire-server /opt/spire/bin/spire-server entry create \
    -parentID spiffe://harbor-satellite.local/agent/edge-01 \
    -spiffeID spiffe://harbor-satellite.local/satellite/region/us-west/edge-01 \
    -selector docker:label:com.docker.compose.service:satellite \
    -socketPath /tmp/spire-server/private/api.sock
```

### 3.4 Start SPIRE agent and Satellite

```bash
docker compose up -d spire-agent-satellite
docker compose up -d satellite
```

### 3.5 Assign config and group to satellite

After the satellite starts and completes SPIFFE ZTR, assign the config and group:

```bash
cd ../gc

curl -sk -X POST https://localhost:9080/api/configs/satellite \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer ${AUTH_TOKEN}" \
    -d '{"satellite": "edge-01", "config_name": "default"}'

curl -sk -X POST https://localhost:9080/api/groups/satellite \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer ${AUTH_TOKEN}" \
    -d '{"satellite": "edge-01", "group": "edge-images"}'
```

### 3.6 Verify

```bash
docker logs satellite
docker exec spire-server /opt/spire/bin/spire-server agent list \
    -socketPath /tmp/spire-server/private/api.sock
```

## Automated Setup

```bash
cd external/gc && ./setup.sh
cd ../sat && ./setup.sh
```

## Cleanup

Satellite must be cleaned up first since it depends on the GC docker network.

```bash
cd external/sat && ./cleanup.sh
cd ../gc && ./cleanup.sh
```
