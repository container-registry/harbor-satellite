# Join Token Attestation

One-time tokens generated by the SPIRE server. Simplest method for getting started.

Tokens are single-use: once a SPIRE agent uses a token to attest, it cannot be reused.

## Prerequisites

- Docker and docker compose installed
- Harbor running (or use SKIP_HARBOR_HEALTH_CHECK=true for testing)
- Ground Control and Satellite built (or use docker images)

## Step 1: Start Ground Control with External SPIRE

### 1.1 Generate bootstrap CA certificate

```bash
cd external/gc
./generate-certs.sh
```

Or manually:
```bash
mkdir -p certs
openssl genrsa -out certs/ca.key 4096
openssl req -new -x509 -days 365 -key certs/ca.key -out certs/ca.crt \
    -subj "/C=US/ST=State/L=City/O=Harbor Satellite/CN=SPIRE CA"
```

### 1.2 Start SPIRE server and PostgreSQL

```bash
docker compose up -d postgres spire-server
```

### 1.3 Wait for SPIRE server to be healthy

```bash
docker exec spire-server /opt/spire/bin/spire-server healthcheck \
    -socketPath /tmp/spire-server/private/api.sock
```

### 1.4 Generate join token for GC agent

```bash
docker exec spire-server /opt/spire/bin/spire-server token generate \
    -spiffeID spiffe://harbor-satellite.local/agent/ground-control \
    -socketPath /tmp/spire-server/private/api.sock
```

Save the token value from the output.

### 1.5 Create agent config with token

Create `spire/agent-gc-runtime.conf` with the token from step 1.4:

```bash
cat > spire/agent-gc-runtime.conf << EOF
agent {
    data_dir = "/opt/spire/data/agent"
    log_level = "INFO"
    server_address = "spire-server"
    server_port = "8081"
    socket_path = "/run/spire/sockets/agent.sock"
    trust_bundle_path = "/opt/spire/conf/agent/bootstrap.crt"
    trust_domain = "harbor-satellite.local"
    join_token = "YOUR_TOKEN_HERE"
}

plugins {
    NodeAttestor "join_token" {
        plugin_data {}
    }
    KeyManager "disk" {
        plugin_data {
            directory = "/opt/spire/data/agent"
        }
    }
    WorkloadAttestor "unix" {
        plugin_data {}
    }
    WorkloadAttestor "docker" {
        plugin_data {
            docker_socket_path = "unix:///var/run/docker.sock"
        }
    }
}

health_checks {
    listener_enabled = true
    bind_address = "0.0.0.0"
    bind_port = "8080"
    live_path = "/live"
    ready_path = "/ready"
}
EOF
```

### 1.6 Start SPIRE agent for GC

```bash
docker compose up -d spire-agent-gc
```

### 1.7 Register GC workload

```bash
docker exec spire-server /opt/spire/bin/spire-server entry create \
    -parentID spiffe://harbor-satellite.local/agent/ground-control \
    -spiffeID spiffe://harbor-satellite.local/ground-control \
    -selector docker:label:com.docker.compose.service:ground-control \
    -socketPath /tmp/spire-server/private/api.sock
```

### 1.8 Start Ground Control

```bash
docker compose up -d ground-control
```

### 1.9 Verify GC is running

```bash
curl http://localhost:8080/ping
curl http://localhost:8080/api/spire/status  # requires auth
```

## Step 2: Start Satellite with External SPIRE

### 2.1 Request join token from Ground Control

```bash
# Login first
curl -c cookies.txt -X POST http://localhost:8080/login \
    -H "Content-Type: application/json" \
    -d '{"username":"admin","password":"password"}'

# Request token
curl -b cookies.txt -X POST http://localhost:8080/api/join-tokens \
    -H "Content-Type: application/json" \
    -d '{"satellite_name":"edge-01","region":"us-west"}'
```

The response includes the join token and SPIRE server connection details:
```json
{
  "join_token": "...",
  "spire_server_address": "spire-server",
  "spire_server_port": 8081,
  "trust_domain": "harbor-satellite.local"
}
```

### 2.2 Create satellite agent config

```bash
cd ../sat
```

Create `spire/agent-satellite-runtime.conf` with the token from step 2.1 (same format as step 1.5).

### 2.3 Start SPIRE agent and Satellite

```bash
docker compose up -d spire-agent-satellite
docker compose up -d satellite
```

### 2.4 Verify

```bash
docker logs satellite
docker exec spire-server /opt/spire/bin/spire-server agent list \
    -socketPath /tmp/spire-server/private/api.sock
```

## Automated Setup

```bash
cd external/gc && ./setup.sh
cd ../sat && ./setup.sh
```

## Cleanup

```bash
cd external/sat && ./cleanup.sh
cd ../gc && ./cleanup.sh
```
