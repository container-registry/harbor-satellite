# Join Token Attestation

One-time tokens generated by the SPIRE server. Simplest method for getting started.

Tokens are single-use: once a SPIRE agent uses a token to attest, it cannot be reused.

## Prerequisites

- Docker and docker compose installed
- Harbor running with at least one image pushed (e.g. `library/nginx:alpine`)

## Step 1: Start Ground Control

### 1.1 Generate bootstrap CA certificate

```bash
cd external/gc
./generate-certs.sh
```

### 1.2 Start SPIRE server and PostgreSQL

```bash
docker compose up -d postgres spire-server
```

Wait for SPIRE server to be healthy:

```bash
docker exec spire-server /opt/spire/bin/spire-server healthcheck \
    -socketPath /tmp/spire-server/private/api.sock
```

### 1.3 Generate join token for GC agent

```bash
docker exec spire-server /opt/spire/bin/spire-server token generate \
    -spiffeID spiffe://harbor-satellite.local/agent/ground-control \
    -socketPath /tmp/spire-server/private/api.sock
```

Save the token value from the output.

### 1.4 Create agent config with token

Create `spire/agent-gc-runtime.conf` using the token from step 1.3:

```bash
cat > spire/agent-gc-runtime.conf << EOF
agent {
    data_dir = "/opt/spire/data/agent"
    log_level = "INFO"
    server_address = "spire-server"
    server_port = "8081"
    socket_path = "/run/spire/sockets/agent.sock"
    trust_bundle_path = "/opt/spire/conf/agent/bootstrap.crt"
    trust_domain = "harbor-satellite.local"
    join_token = "YOUR_TOKEN_HERE"
}

plugins {
    NodeAttestor "join_token" {
        plugin_data {}
    }
    KeyManager "disk" {
        plugin_data {
            directory = "/opt/spire/data/agent"
        }
    }
    WorkloadAttestor "unix" {
        plugin_data {}
    }
    WorkloadAttestor "docker" {
        plugin_data {
            docker_socket_path = "unix:///var/run/docker.sock"
        }
    }
}

health_checks {
    listener_enabled = true
    bind_address = "0.0.0.0"
    bind_port = "8080"
    live_path = "/live"
    ready_path = "/ready"
}
EOF
```

### 1.5 Start SPIRE agent for GC

```bash
docker compose up -d spire-agent-gc
```

### 1.6 Register GC workload

```bash
docker exec spire-server /opt/spire/bin/spire-server entry create \
    -parentID spiffe://harbor-satellite.local/agent/ground-control \
    -spiffeID spiffe://harbor-satellite.local/ground-control \
    -selector docker:label:com.docker.compose.service:ground-control \
    -socketPath /tmp/spire-server/private/api.sock
```

### 1.7 Start Ground Control

```bash
docker compose up -d ground-control --build
```

### 1.8 Verify GC is running

GC serves HTTPS when SPIFFE is enabled. Use `-k` to skip certificate verification.

```bash
curl -sk https://localhost:9080/ping
```

## Step 2: Login and Get Auth Token

```bash
LOGIN_RESP=$(curl -sk -X POST https://localhost:9080/login \
    -H "Content-Type: application/json" \
    -d '{"username":"admin","password":"Harbor12345"}')
AUTH_TOKEN=$(echo "$LOGIN_RESP" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
```

## Step 3: Register Satellite

Register the satellite with Ground Control. This creates a join token, registers the SPIRE workload entry, creates the satellite DB record, and provisions a robot account in Harbor.

```bash
curl -sk -X POST https://localhost:9080/api/satellites/register \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer ${AUTH_TOKEN}" \
    -d '{
      "satellite_name": "edge-01",
      "region": "us-west",
      "selectors": ["docker:label:com.docker.compose.service:satellite"],
      "attestation_method": "join_token"
    }'
```

The response includes the join token and SPIRE connection details:

```json
{
  "satellite": "edge-01",
  "region": "us-west",
  "spiffe_id": "spiffe://harbor-satellite.local/satellite/region/us-west/edge-01",
  "parent_agent_id": "spiffe://harbor-satellite.local/agent/edge-01",
  "join_token": "...",
  "expires_at": "...",
  "spire_server_address": "spire-server",
  "spire_server_port": 8081,
  "trust_domain": "harbor-satellite.local"
}
```

Save the `join_token` value.

## Step 4: Start Satellite

### 4.1 Create satellite agent config

```bash
cd ../sat
```

Create `spire/agent-satellite-runtime.conf` using the join token from step 3:

```bash
cat > spire/agent-satellite-runtime.conf << EOF
agent {
    data_dir = "/opt/spire/data/agent"
    log_level = "INFO"
    server_address = "spire-server"
    server_port = "8081"
    socket_path = "/run/spire/sockets/agent.sock"
    trust_bundle_path = "/opt/spire/conf/agent/bootstrap.crt"
    trust_domain = "harbor-satellite.local"
    join_token = "YOUR_TOKEN_HERE"
}

plugins {
    NodeAttestor "join_token" {
        plugin_data {}
    }
    KeyManager "disk" {
        plugin_data {
            directory = "/opt/spire/data/agent"
        }
    }
    WorkloadAttestor "unix" {
        plugin_data {}
    }
    WorkloadAttestor "docker" {
        plugin_data {
            docker_socket_path = "unix:///var/run/docker.sock"
        }
    }
}

health_checks {
    listener_enabled = true
    bind_address = "0.0.0.0"
    bind_port = "8080"
    live_path = "/live"
    ready_path = "/ready"
}
EOF
```

### 4.2 Start SPIRE agent and satellite

```bash
docker compose up -d spire-agent-satellite
docker compose up -d satellite --build
```

The satellite performs SPIFFE ZTR (zero trust registration) on startup, which completes its registration with Ground Control and obtains credentials.

Check logs to confirm ZTR succeeded:

```bash
docker logs satellite
```

Look for messages indicating successful SPIFFE authentication and registration.

## Step 5: Create and Assign Config

After the satellite has started and completed ZTR, create a config and assign it.

### 5.1 Create a satellite config

```bash
cd ../gc

curl -sk -X POST https://localhost:9080/api/configs \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer ${AUTH_TOKEN}" \
    -d '{
      "config_name": "default",
      "config": {
        "app_config": {
          "log_level": "info",
          "state_replication_interval": "@every 00h00m30s",
          "register_satellite_interval": "@every 00h00m05s",
          "heartbeat_interval": "@every 00h00m30s",
          "metrics": {
            "collect_cpu": true,
            "collect_memory": true,
            "collect_storage": true
          },
          "local_registry": {
            "url": "http://127.0.0.1:8585"
          }
        },
        "zot_config": {
          "distSpecVersion": "1.1.0",
          "storage": { "rootDirectory": "./zot" },
          "http": { "address": "0.0.0.0", "port": "8585" },
          "log": { "level": "info" }
        }
      }
    }'
```

### 5.2 Assign config to satellite

```bash
curl -sk -X POST https://localhost:9080/api/configs/satellite \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer ${AUTH_TOKEN}" \
    -d '{"satellite": "edge-01", "config_name": "default"}'
```

## Step 6: Create and Assign Group

### 6.1 Push an image to Harbor (if not already present)

```bash
docker pull nginx:alpine
docker tag nginx:alpine localhost:8080/library/nginx:alpine
docker push localhost:8080/library/nginx:alpine
```

### 6.2 Create a group with images

Replace the digest with the actual digest from your Harbor instance:

```bash
curl -sk -X POST https://localhost:9080/api/groups/sync \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer ${AUTH_TOKEN}" \
    -d '{
      "group": "edge-images",
      "registry": "http://localhost:8080",
      "artifacts": [
        {
          "repository": "library/nginx",
          "tag": ["alpine"],
          "type": "image",
          "digest": "sha256:YOUR_DIGEST_HERE"
        }
      ]
    }'
```

### 6.3 Assign group to satellite

```bash
curl -sk -X POST https://localhost:9080/api/groups/satellite \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer ${AUTH_TOKEN}" \
    -d '{"satellite": "edge-01", "group": "edge-images"}'
```

## Step 7: Verify

### Check satellite logs for replication

```bash
docker logs satellite
```

Look for messages indicating image replication succeeded.

### Pull from the satellite registry

The satellite's local Zot registry is exposed on port 5050 (configurable via `SATELLITE_ZOT_PORT`):

```bash
docker pull localhost:5050/library/nginx:alpine --tls-verify=false
```

Or with podman:

```bash
podman pull localhost:5050/library/nginx:alpine --tls-verify=false
```

### Check SPIRE agent status

```bash
docker exec spire-server /opt/spire/bin/spire-server agent list \
    -socketPath /tmp/spire-server/private/api.sock
```

### Check satellite status in Ground Control

```bash
curl -sk https://localhost:9080/api/satellites \
    -H "Authorization: Bearer ${AUTH_TOKEN}" | jq .
```

## Automated Setup

```bash
cd external/gc && ./setup.sh
cd ../sat && ./setup.sh
```

Note: the automated scripts handle token generation, agent config creation, and workload registration. You still need to create configs, groups, and assign them to the satellite manually after setup completes.

## Cleanup

Satellite must be cleaned up first since it depends on the GC docker network.

```bash
cd external/sat && ./cleanup.sh
cd ../gc && ./cleanup.sh
```
