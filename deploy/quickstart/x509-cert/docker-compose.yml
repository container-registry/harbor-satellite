# Docker Compose for X.509 Certificate SPIFFE Authentication
# This setup demonstrates SPIFFE authentication using X.509 PoP attestation

services:
  # PostgreSQL for Ground Control
  postgres:
    image: postgres:15-alpine
    container_name: harbor-satellite-postgres
    environment:
      POSTGRES_USER: harbor
      POSTGRES_PASSWORD: harbor
      POSTGRES_DB: harbor_satellite
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U harbor -d harbor_satellite"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - harbor-satellite

  # Mock Harbor Registry
  mock-harbor:
    image: ghcr.io/project-zot/zot-linux-amd64:v2.1.1
    container_name: mock-harbor
    volumes:
      - ../common/mock-harbor-config.json:/etc/zot/config.json:ro
      - mock-harbor-data:/var/lib/zot
    ports:
      - "5000:5000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/v2/"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - harbor-satellite

  # SPIRE Server with X.509 PoP
  spire-server:
    image: ghcr.io/spiffe/spire-server:1.10.4
    container_name: spire-server
    hostname: spire-server
    command: ["-config", "/opt/spire/conf/server/server.conf"]
    volumes:
      - ./spire/server.conf:/opt/spire/conf/server/server.conf:ro
      - ./certs/ca.crt:/opt/spire/conf/server/ca.crt:ro
      - ./certs/ca.key:/opt/spire/conf/server/ca.key:ro
      - ./certs/x509pop-ca.crt:/opt/spire/conf/server/x509pop-ca.crt:ro
      - spire-server-data:/opt/spire/data/server
      - spire-server-socket:/tmp/spire-server/private
    ports:
      - "8081:8081"
    healthcheck:
      test: ["CMD-SHELL", "/opt/spire/bin/spire-server healthcheck -socketPath /tmp/spire-server/private/api.sock"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - harbor-satellite

  # SPIRE Agent for Ground Control (X.509 PoP)
  spire-agent-gc:
    image: ghcr.io/spiffe/spire-agent:1.10.4
    container_name: spire-agent-gc
    hostname: spire-agent-gc
    command: ["-config", "/opt/spire/conf/agent/agent.conf"]
    volumes:
      - ./spire/agent-gc.conf:/opt/spire/conf/agent/agent.conf:ro
      - ./certs/ca.crt:/opt/spire/conf/agent/bootstrap.crt:ro
      - ./certs/agent-gc.crt:/opt/spire/conf/agent/agent.crt:ro
      - ./certs/agent-gc.key:/opt/spire/conf/agent/agent.key:ro
      - spire-agent-gc-data:/opt/spire/data/agent
      - spire-agent-gc-socket:/run/spire/sockets
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      spire-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "/opt/spire/bin/spire-agent healthcheck -socketPath /run/spire/sockets/agent.sock"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - harbor-satellite

  # SPIRE Agent for Satellite (X.509 PoP)
  spire-agent-satellite:
    image: ghcr.io/spiffe/spire-agent:1.10.4
    container_name: spire-agent-satellite
    hostname: spire-agent-satellite
    command: ["-config", "/opt/spire/conf/agent/agent.conf"]
    volumes:
      - ./spire/agent-satellite.conf:/opt/spire/conf/agent/agent.conf:ro
      - ./certs/ca.crt:/opt/spire/conf/agent/bootstrap.crt:ro
      - ./certs/agent-satellite.crt:/opt/spire/conf/agent/agent.crt:ro
      - ./certs/agent-satellite.key:/opt/spire/conf/agent/agent.key:ro
      - spire-agent-satellite-data:/opt/spire/data/agent
      - spire-agent-satellite-socket:/run/spire/sockets
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      spire-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "/opt/spire/bin/spire-agent healthcheck -socketPath /run/spire/sockets/agent.sock"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - harbor-satellite

  # Ground Control
  ground-control:
    build:
      context: ../../../../ground-control
      dockerfile: Dockerfile
    container_name: ground-control
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_DATABASE=harbor_satellite
      - DB_USERNAME=harbor
      - DB_PASSWORD=harbor
      - PORT=8080
      - APP_ENV=development
      - HARBOR_URL=http://mock-harbor:5000
      - HARBOR_USERNAME=admin
      - HARBOR_PASSWORD=admin
      - SKIP_HARBOR_HEALTH_CHECK=true
      - SPIFFE_ENABLED=true
      - SPIFFE_ENDPOINT_SOCKET=unix:///run/spire/sockets/agent.sock
      - SPIFFE_TRUST_DOMAIN=harbor-satellite.local
    volumes:
      - spire-agent-gc-socket:/run/spire/sockets:ro
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      spire-agent-gc:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - harbor-satellite

  # Satellite
  satellite:
    build:
      context: ../../../..
      dockerfile: Dockerfile
    container_name: satellite
    environment:
      - GROUND_CONTROL_URL=https://ground-control:8080
      - SPIFFE_ENABLED=true
      - SPIFFE_ENDPOINT_SOCKET=unix:///run/spire/sockets/agent.sock
      - SPIFFE_EXPECTED_SERVER_ID=spiffe://harbor-satellite.local/ground-control
    volumes:
      - spire-agent-satellite-socket:/run/spire/sockets:ro
      - satellite-data:/data
    depends_on:
      ground-control:
        condition: service_healthy
      spire-agent-satellite:
        condition: service_healthy
    networks:
      - harbor-satellite

volumes:
  postgres-data:
  mock-harbor-data:
  spire-server-data:
  spire-server-socket:
  spire-agent-gc-data:
  spire-agent-gc-socket:
  spire-agent-satellite-data:
  spire-agent-satellite-socket:
  satellite-data:

networks:
  harbor-satellite:
    name: harbor-satellite
