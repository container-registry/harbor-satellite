version: "3"

vars:
  PLATFORMS: linux/amd64,linux/arm64,linux/ppc64le,linux/s390x,linux/riscv64

tasks:
  both:
    desc: Publish both satellite and ground-control
    vars:
      TAG: "{{.TAG | default \"dev\"}}"
      REGISTRY:
        sh: echo "{{.DEST}}" | cut -d'/' -f1
      PROJECT:
        sh: echo "{{.DEST}}" | cut -d'/' -f2-
    preconditions:
      - sh: test -n "{{.DEST}}"
        msg: |
          DEST is required.

          Usage:
            task publish DEST=<registry>/<project> [TAG=<tag>]

          Examples:
            task publish DEST=ttl.sh/my-project
            task publish DEST=ghcr.io/myorg/harbor-satellite TAG=v1.0.0

          For private registries, set credentials via environment:
            REG_USER=user REG_PASS=pass task publish DEST=ghcr.io/myorg/project
    cmds:
      - echo "Publishing to {{.DEST}} with tag {{.TAG}}..."
      - task: image
        vars:
          REGISTRY: "{{.REGISTRY}}"
          PROJECT_NAME: "{{.PROJECT}}"
          COMPONENT: satellite
          IMAGE_TAGS: "{{.TAG}}"
      - task: image
        vars:
          REGISTRY: "{{.REGISTRY}}"
          PROJECT_NAME: "{{.PROJECT}}"
          COMPONENT: ground-control
          IMAGE_TAGS: "{{.TAG}}"
      - echo "Published satellite and ground-control to {{.DEST}}"
    silent: true

  image:
    desc: Build and push multi-arch or single-platform container image
    vars:
      REGISTRY: "{{.REGISTRY | default .Env.REGISTRY}}"
      PROJECT_NAME: "{{.PROJECT_NAME | default .Env.PROJECT_NAME}}"
      COMPONENT: "{{.COMPONENT | default .Env.COMPONENT | default \"satellite\"}}"
      IMAGE_TAGS: "{{.IMAGE_TAGS | default .Env.IMAGE_TAGS | default \"dev\"}}"
      PLATFORM: "{{.PLATFORM | default .Env.PLATFORM}}"
      TAG_SUFFIX: "{{.TAG_SUFFIX | default .Env.TAG_SUFFIX}}"
    preconditions:
      - sh: test -n "{{.REGISTRY}}"
        msg: "REGISTRY is required. Set via task var or REGISTRY env var."
      - sh: test -n "{{.PROJECT_NAME}}"
        msg: "PROJECT_NAME is required. Set via task var or PROJECT_NAME env var."
    cmds:
      - |
        DOCKERFILE="Dockerfile"
        CONTEXT="."
        if [ "{{.COMPONENT}}" = "ground-control" ]; then
          DOCKERFILE="ground-control/Dockerfile"
          CONTEXT="ground-control"
        fi

        # Login if credentials provided (REG_USER/REG_PASS)
        if [ -n "$REG_USER" ] && [ -n "$REG_PASS" ]; then
          echo "Logging into {{.REGISTRY}}..."
          echo "$REG_PASS" | docker login {{.REGISTRY}} -u "$REG_USER" --password-stdin
        fi

        # Platform: single PLATFORM or all PLATFORMS
        if [ -n "{{.PLATFORM}}" ]; then
          PLATFORMS="{{.PLATFORM}}"
        else
          PLATFORMS="{{.PLATFORMS}}"
        fi

        # Build tags list for buildx (append TAG_SUFFIX when set)
        TAGS=""
        for tag in $(echo "{{.IMAGE_TAGS}}" | tr ',' ' '); do
          tag=$(echo "$tag" | sed 's/^v//')
          if [ -n "{{.TAG_SUFFIX}}" ]; then
            tag="${tag}-{{.TAG_SUFFIX}}"
          fi
          TAGS="$TAGS -t {{.REGISTRY}}/{{.PROJECT_NAME}}/{{.COMPONENT}}:$tag"
        done

        echo "Building and pushing {{.COMPONENT}} for $PLATFORMS..."
        docker buildx build \
          --platform $PLATFORMS \
          -f $DOCKERFILE \
          $TAGS \
          --push \
          $CONTEXT
      - echo "Published {{.COMPONENT}}"
    silent: true

  image-and-sign:
    desc: Build, push, and optionally sign (when not single-platform) container image with Cosign
    vars:
      REGISTRY: "{{.REGISTRY | default .Env.REGISTRY}}"
      PROJECT_NAME: "{{.PROJECT_NAME | default .Env.PROJECT_NAME}}"
      COMPONENT: "{{.COMPONENT | default .Env.COMPONENT | default \"satellite\"}}"
      IMAGE_TAGS: "{{.IMAGE_TAGS | default .Env.IMAGE_TAGS | default \"dev\"}}"
      PLATFORM: "{{.PLATFORM | default .Env.PLATFORM}}"
      TAG_SUFFIX: "{{.TAG_SUFFIX | default .Env.TAG_SUFFIX}}"
    preconditions:
      - sh: test -n "{{.REGISTRY}}"
        msg: "REGISTRY is required. Set via task var or REGISTRY env var."
      - sh: test -n "{{.PROJECT_NAME}}"
        msg: "PROJECT_NAME is required. Set via task var or PROJECT_NAME env var."
    cmds:
      - task: image
        vars:
          REGISTRY: "{{.REGISTRY}}"
          PROJECT_NAME: "{{.PROJECT_NAME}}"
          COMPONENT: "{{.COMPONENT}}"
          IMAGE_TAGS: "{{.IMAGE_TAGS}}"
          PLATFORM: "{{.PLATFORM}}"
          TAG_SUFFIX: "{{.TAG_SUFFIX}}"
      - |
        # Sign only when building multi-arch (no PLATFORM set); single-arch is signed in manifest job
        if [ -z "{{.PLATFORM}}" ]; then
          echo "Signing {{.COMPONENT}} image..."
          FIRST_TAG=$(echo "{{.IMAGE_TAGS}}" | cut -d',' -f1 | sed 's/^v//')
          IMAGE_ADDR="{{.REGISTRY}}/{{.PROJECT_NAME}}/{{.COMPONENT}}:$FIRST_TAG"
          cosign sign --yes --recursive \
            --registry-username="$REG_USER" \
            --registry-password="$REG_PASS" \
            "$IMAGE_ADDR" \
            --timeout 1m
          echo "Signed {{.COMPONENT}}"
        fi
    silent: true

  manifest-list-and-sign:
    desc: Create multi-arch manifest list from per-arch tags and sign with Cosign
    vars:
      REGISTRY: "{{.REGISTRY | default .Env.REGISTRY}}"
      PROJECT_NAME: "{{.PROJECT_NAME | default .Env.PROJECT_NAME}}"
      BASE_TAG: "{{.BASE_TAG | default .Env.BASE_TAG | default \"latest\"}}"
      SUFFIXES: "{{.SUFFIXES | default .Env.SUFFIXES | default \"amd64 arm64 ppc64le s390x riscv64\"}}"
    preconditions:
      - sh: test -n "{{.REGISTRY}}"
        msg: "REGISTRY is required."
      - sh: test -n "{{.PROJECT_NAME}}"
        msg: "PROJECT_NAME is required."
    cmds:
      - |
        if [ -n "$REG_USER" ] && [ -n "$REG_PASS" ]; then
          echo "Logging into {{.REGISTRY}}..."
          echo "$REG_PASS" | docker login {{.REGISTRY}} -u "$REG_USER" --password-stdin
        fi
      - |
        for COMPONENT in satellite ground-control; do
          SOURCES=""
          for suf in {{.SUFFIXES}}; do
            SOURCES="$SOURCES {{.REGISTRY}}/{{.PROJECT_NAME}}/$COMPONENT:{{.BASE_TAG}}-$suf"
          done
          echo "Creating manifest list for $COMPONENT:{{.BASE_TAG}}..."
          docker buildx imagetools create -t {{.REGISTRY}}/{{.PROJECT_NAME}}/$COMPONENT:{{.BASE_TAG}} $SOURCES
          echo "Signing $COMPONENT..."
          cosign sign --yes --recursive \
            --registry-username="$REG_USER" \
            --registry-password="$REG_PASS" \
            "{{.REGISTRY}}/{{.PROJECT_NAME}}/$COMPONENT:{{.BASE_TAG}}" \
            --timeout 5m
        done
      - echo "Manifest lists created and signed"
    silent: true

  snapshot-release:
    desc: Create snapshot release with GoReleaser
    cmds:
      - echo "Creating snapshot release..."
      - goreleaser release --snapshot --clean
      - echo "Snapshot release created in dist/"
    generates:
      - dist/**
    silent: true

  release:
    desc: Create official release with GoReleaser
    preconditions:
      - sh: test -n "$GITHUB_TOKEN"
        msg: GITHUB_TOKEN environment variable is required
    cmds:
      - echo "Creating release..."
      - goreleaser release --clean
      - echo "Release complete!"
    silent: true
